// Expense categories theo yÃªu cáº§u má»›i const categories = { // Chi phÃ­ xe Ã´ tÃ´ 'chi phÃ­ xe Ã´ tÃ´': { emoji: 'ğŸš—', subcategories: ['xÄƒng', 'rá»­a xe', 'vetc', 'thu phÃ­ khÃ´ng dá»«ng', 'sá»­a chá»¯a', 'vÃ© Ä‘á»— xe', 'cáº§u Ä‘Æ°á»ng', 'phÃ­ Ä‘Æ°á»ng', 'khÃ¡c xe'] }, 'xÄƒng': { emoji: 'â›½', subcategories: ['xÄƒng', 'nhiÃªn liá»‡u'] }, 'rá»­a xe': { emoji: 'ğŸ§½', subcategories: ['rá»­a xe', 'vá»‡ sinh xe'] }, 'vetc': { emoji: 'ğŸ«', subcategories: ['vetc', 'thu phÃ­ khÃ´ng dá»«ng', 'phÃ­ Ä‘Æ°á»ng'] }, 'sá»­a chá»¯a xe': { emoji: 'ğŸ”§', subcategories: ['sá»­a chá»¯a', 'báº£o dÆ°á»¡ng', 'thay Ä‘á»“'] }, 'Ä‘á»— xe': { emoji: 'ğŸ…¿ï¸', subcategories: ['vÃ© Ä‘á»— xe', 'cáº§u Ä‘Æ°á»ng', 'phÃ­ Ä‘á»— xe'] }, // NhÃ  hÃ ng (Äƒn uá»‘ng) 'nhÃ  hÃ ng': { emoji: 'ğŸ½ï¸', subcategories: ['Äƒn sÃ¡ng', 'Äƒn trÆ°a', 'Äƒn tá»‘i', 'Äƒn váº·t', 'cafÃ©', 'trÃ  sá»¯a', 'nÆ°á»›c uá»‘ng', 'buffet', 'cÆ¡m', 'phá»Ÿ', 'bÃºn', 'mÃ¬'] }, 'Äƒn uá»‘ng': { emoji: 'ğŸ´', subcategories: ['Äƒn sÃ¡ng', 'Äƒn trÆ°a', 'Äƒn tá»‘i', 'Äƒn váº·t'] }, 'cafÃ©': { emoji: 'â˜•', subcategories: ['cÃ  phÃª', 'trÃ ', 'nÆ°á»›c Ã©p', 'sinh tá»‘'] }, 'Äƒn sÃ¡ng': { emoji: 'ğŸ³', subcategories: ['phá»Ÿ', 'bÃ¡nh mÃ¬', 'cÆ¡m', 'xÃ´i'] }, 'Äƒn trÆ°a': { emoji: 'ğŸ±', subcategories: ['cÆ¡m', 'bÃºn', 'phá»Ÿ', 'mÃ¬'] }, 'Äƒn tá»‘i': { emoji: 'ğŸ½ï¸', subcategories: ['cÆ¡m', 'láº©u', 'nÆ°á»›ng', 'pizza'] }, // Giao nháº­n Ä‘á»“ 'giao nháº­n Ä‘á»“': { emoji: 'ğŸ“¦', subcategories: ['giao Ä‘á»“', 'nháº­n Ä‘á»“', 'shipper', 'grab food', 'now', 'baemin', 'shopee food', 'gojek', 'phÃ­ ship'] }, 'giao Ä‘á»“': { emoji: 'ğŸšš', subcategories: ['giao Ä‘á»“', 'delivery', 'shipper'] }, 'ship Ä‘á»“': { emoji: 'ğŸ“®', subcategories: ['phÃ­ ship', 'giao hÃ ng', 'váº­n chuyá»ƒn'] }, // Mua Ä‘á»“/dá»‹ch vá»¥ 'mua Ä‘á»“': { emoji: 'ğŸ›’', subcategories: ['quáº§n Ã¡o', 'giÃ y dÃ©p', 'má»¹ pháº©m', 'Ä‘á»“ gia dá»¥ng', 'Ä‘iá»‡n tá»­', 'sÃ¡ch', 'Ä‘á»“ chÆ¡i', 'phá»¥ kiá»‡n'] }, 'dá»‹ch vá»¥': { emoji: 'ğŸ”§', subcategories: ['cáº¯t tÃ³c', 'massage', 'nail', 'spa', 'gym', 'há»c phÃ­', 'khÃ³a há»c', 'sá»­a chá»¯a', 'báº£o hiá»ƒm'] }, 'mua sáº¯m': { emoji: 'ğŸ›ï¸', subcategories: ['quáº§n Ã¡o', 'giÃ y dÃ©p', 'má»¹ pháº©m', 'Ä‘á»“ dÃ¹ng'] }, 'shopping': { emoji: 'ğŸ›’', subcategories: ['mua Ä‘á»“', 'shopping'] }, // Chi phÃ­ khÃ¡c 'chi phÃ­ khÃ¡c': { emoji: 'ğŸ’°', subcategories: ['khÃ¡c', 'linh tinh', 'phÃ­ bank', 'thuáº¿', 'pháº¡t', 'tá»« thiá»‡n', 'quÃ  táº·ng', 'y táº¿', 'thuá»‘c'] }, 'khÃ¡c': { emoji: 'ğŸ“', subcategories: ['khÃ¡c', 'linh tinh', 'chÆ°a phÃ¢n loáº¡i'] } }; // Payment methods mapping const paymentMethods = { 'tiá»n máº·t': 'Tiá»n máº·t', 'cash': 'Tiá»n máº·t', 'banking': 'Banking', 'chuyá»ƒn khoáº£n': 'Banking', 'tháº»': 'Tháº» tÃ­n dá»¥ng', 'card': 'Tháº» tÃ­n dá»¥ng', 'momo': 'VÃ­ MoMo', 'zalopay': 'ZaloPay', 'shopee': 'ShopeePay', 'vÃ­ Ä‘iá»‡n tá»­': 'VÃ­ Ä‘iá»‡n tá»­' }; // Enhanced parsing function cho categories má»›i function parseExpense(text) { const input = text.toLowerCase().trim(); // Extract amount const amountRegex = /(\d{1,3}(?:[,.]?\d{3})*)[k|Ä‘|vnd|d|ng|nghÃ¬n|triá»‡u]?/i; const amountMatch = input.match(amountRegex); let amount = 0; let category = 'Chi phÃ­ khÃ¡c'; let emoji = 'ğŸ’°'; let subcategory = 'KhÃ¡c'; let paymentMethod = 'Tiá»n máº·t'; let quantity = 1; let type = 'Chi'; if (amountMatch) { let amountStr = amountMatch[1].replace(/[,\.]/g, ''); amount = parseInt(amountStr); if (input.includes('k') || input.includes('nghÃ¬n')) { if (amount < 1000) amount *= 1000; } else if (input.includes('triá»‡u')) { amount *= 1000000; } } // Find main category and subcategory vá»›i priority matching let bestMatch = ''; let matchLength = 0; // Specific keyword matching vá»›i Ä‘á»™ Æ°u tiÃªn const categoryKeywords = { // Chi phÃ­ xe Ã´ tÃ´ keywords 'chi phÃ­ xe Ã´ tÃ´': ['xÄƒng', 'rá»­a xe', 'vetc', 'sá»­a xe', 'Ä‘á»— xe', 'phÃ­ Ä‘Æ°á»ng', 'cáº§u Ä‘Æ°á»ng'], 'xÄƒng': ['xÄƒng', 'nhiÃªn liá»‡u', 'petrol'], 'rá»­a xe': ['rá»­a xe', 'vá»‡ sinh xe'], 'vetc': ['vetc', 'thu phÃ­', 'phÃ­ Ä‘Æ°á»ng', 'cao tá»‘c'], 'sá»­a chá»¯a xe': ['sá»­a xe', 'báº£o dÆ°á»¡ng', 'thay Ä‘á»“', 'sá»­a chá»¯a'], 'Ä‘á»— xe': ['Ä‘á»— xe', 'vÃ© Ä‘á»—', 'phÃ­ Ä‘á»—', 'cáº§u Ä‘Æ°á»ng'], // NhÃ  hÃ ng keywords 'nhÃ  hÃ ng': ['Äƒn sÃ¡ng', 'Äƒn trÆ°a', 'Äƒn tá»‘i', 'Äƒn uá»‘ng', 'cafÃ©', 'cÃ  phÃª', 'phá»Ÿ', 'cÆ¡m', 'bÃºn', 'mÃ¬', 'nhÃ  hÃ ng', 'quÃ¡n Äƒn'], 'Äƒn sÃ¡ng': ['Äƒn sÃ¡ng', 'sÃ¡ng', 'phá»Ÿ', 'bÃ¡nh mÃ¬', 'xÃ´i'], 'Äƒn trÆ°a': ['Äƒn trÆ°a', 'trÆ°a', 'cÆ¡m trÆ°a'], 'Äƒn tá»‘i': ['Äƒn tá»‘i', 'tá»‘i', 'cÆ¡m tá»‘i'], 'cafÃ©': ['cafÃ©', 'cÃ  phÃª', 'coffee', 'trÃ ', 'nÆ°á»›c'], // Giao nháº­n Ä‘á»“ keywords 'giao nháº­n Ä‘á»“': ['giao Ä‘á»“', 'nháº­n Ä‘á»“', 'ship', 'shipper', 'grab food', 'now', 'baemin', 'delivery'], 'giao Ä‘á»“': ['giao Ä‘á»“', 'delivery', 'ship Ä‘á»“'], 'ship Ä‘á»“': ['ship', 'phÃ­ ship', 'giao hÃ ng'], // Mua Ä‘á»“/dá»‹ch vá»¥ keywords 'mua Ä‘á»“': ['mua Ä‘á»“', 'mua sáº¯m', 'shopping', 'quáº§n Ã¡o', 'giÃ y', 'má»¹ pháº©m', 'Ä‘á»“ gia dá»¥ng'], 'dá»‹ch vá»¥': ['dá»‹ch vá»¥', 'cáº¯t tÃ³c', 'massage', 'spa', 'gym', 'há»c phÃ­'], 'mua sáº¯m': ['mua sáº¯m', 'shopping', 'mua Ä‘á»“'], // Chi phÃ­ khÃ¡c keywords 'chi phÃ­ khÃ¡c': ['khÃ¡c', 'linh tinh', 'phÃ­ bank', 'thuáº¿', 'pháº¡t', 'tá»« thiá»‡n'] }; // TÃ¬m category match tá»‘t nháº¥t for (let [catName, keywords] of Object.entries(categoryKeywords)) { for (let keyword of keywords) { if (input.includes(keyword) && keyword.length > matchLength) { bestMatch = catName; matchLength = keyword.length; subcategory = keyword.charAt(0).toUpperCase() + keyword.slice(1); } } } if (bestMatch && categories[bestMatch]) { category = bestMatch.charAt(0).toUpperCase() + bestMatch.slice(1); emoji = categories[bestMatch].emoji; } // Find payment method for (let method in paymentMethods) { if (input.includes(method)) { paymentMethod = paymentMethods[method]; break; } } // Extract quantity if mentioned const quantityRegex = /(\d+)\s*(cÃ¡i|ly|tÃ´|pháº§n|suáº¥t|láº§n|lÃ­t)/i; const quantityMatch = input.match(quantityRegex); if (quantityMatch) { quantity = parseInt(quantityMatch[1]); } // Detect if it's income if (input.includes('thu') || input.includes('nháº­n') || input.includes('lÆ°Æ¡ng') || input.includes('thÆ°á»Ÿng')) { type = 'Thu'; category = 'Thu nháº­p'; emoji = 'ğŸ’µ'; } return { amount, category, emoji, subcategory: subcategory || category, paymentMethod, quantity, type, description: text.trim() }; } // Enhanced save to sheet function async function saveToSheet(userId, username, expenseData) { try { await doc.loadInfo(); const sheet = doc.sheetsByIndex[0]; const now = new Date(); const dateStr = now.toLocaleDateString('vi-VN'); const timeStr = now.toLocaleTimeString('vi-VN'); await sheet.addRow({ 'NgÃ y': dateStr, 'Danh má»¥c': expenseData.category, 'MÃ´ táº£': expenseData.description, 'Sá»‘ tiá»n': expenseData.amount, 'Loáº¡i': expenseData.type, 'Link hÃ³a Ä‘Æ¡n': '', // Will be updated when user sends photo 'Thá»i gian': timeStr, 'Danh má»¥c phá»¥': expenseData.subcategory, 'Sá»‘ lÆ°á»£ng': expenseData.quantity, 'PhÆ°Æ¡ng thá»©c thanh toÃ¡n': expenseData.paymentMethod, 'Ghi chÃº': `${username} (${userId})` }); return true; } catch (error) { console.error('Error saving to sheet:', error); return false; } } // Enhanced response message bot.on('text', async (ctx) => { const text = ctx.message.text; if (text.startsWith('/')) return; const expense = parseExpense(text); if (expense.amount <= 0) { return ctx.reply('âŒ KhÃ´ng thá»ƒ nháº­n diá»‡n sá»‘ tiá»n.\n\nğŸ’¡ VÃ­ dá»¥: "Ä‚n sÃ¡ng 100k momo" hoáº·c "2 ly cafÃ© 90k banking"'); } // Enhanced confirmation message const confirmMsg = `âœ… *ÄÃ£ phÃ¢n tÃ­ch chi tiÃªu:* ${expense.emoji} *Danh má»¥c:* ${expense.category} ğŸ·ï¸ *Danh má»¥c phá»¥:* ${expense.subcategory} ğŸ’° *Sá»‘ tiá»n:* ${expense.amount.toLocaleString('vi-VN')}â‚« ğŸ“Š *Loáº¡i:* ${expense.type} ğŸ”¢ *Sá»‘ lÆ°á»£ng:* ${expense.quantity} ğŸ’³ *Thanh toÃ¡n:* ${expense.paymentMethod} ğŸ“ *MÃ´ táº£:* ${expense.description} â³ Äang lÆ°u vÃ o Google Sheet...`; const loadingMsg = await ctx.replyWithMarkdown(confirmMsg); const saved = await saveToSheet( ctx.from.id, ctx.from.username || ctx.from.first_name, expense ); if (saved) { await ctx.telegram.editMessageText( ctx.chat.id, loadingMsg.message_id, null, confirmMsg.replace('â³ Äang lÆ°u vÃ o Google Sheet...', 'âœ… *ÄÃ£ lÆ°u thÃ nh cÃ´ng!*'), { parse_mode: 'Markdown' } ); } else { await ctx.telegram.editMessageText( ctx.chat.id, loadingMsg.message_id, null, 'âŒ CÃ³ lá»—i khi lÆ°u. Vui lÃ²ng thá»­ láº¡i sau.' ); } });
